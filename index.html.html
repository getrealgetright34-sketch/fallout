<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS-LINK // MOD WORKBENCH</title>
    <style>
        /* --- CORE RETRO AESTHETICS --- */
        :root {
            --bg-color: #050a05;
            --term-green: #33ff33;
            --term-amber: #ffb833;
            --term-dim: #1a4d1a;
            --term-red: #ff3333;
            --scanline-color: rgba(0, 0, 0, 0.5);
            --font-main: 'Courier New', Courier, monospace;
        }

        body {
            background:
            /* 主背景色 */
            var(--bg-color)
            /* 叠加一张低透明度的废土风格纹理图 */
            url('https://www.reddit.com/media?url=https%3A%2F%2Fi.redd.it%2Fer9ls2xxf5t31.jpg');
            background-blend-mode: overlay; /* 混合模式让纹理融合更好 */
            background-size: cover;
            background-attachment: fixed; /* 纹理固定，滚动时不动 */
            color: var(--term-green);
            font-family: var(--font-main);
            margin: 0;
            padding: 20px;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            user-select: none; /* Prevent text selection during drag */
        }

        /* Scanline Overlay */
        .crt-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 999;
        }

        /* --- LAYOUT GRID --- */
        .workbench-grid {
            display: grid;
            grid-template-columns: 250px 1fr 250px; /* Left, Center, Right */
            grid-template-rows: 1fr 200px; /* Main area, Bottom Assembly */
            gap: 15px;
            height: 100%;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* --- PANEL STYLING --- */
        .panel {
            border: 2px solid var(--term-dim);
            background: rgba(0, 20, 0, 0.3);
            padding: 15px;
            position: relative;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 10px rgba(51, 255, 51, 0.1);
        }

        .panel-header {
            background-color: var(--term-dim);
            color: var(--term-green);
            padding: 5px 10px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin: -15px -15px 15px -15px; /* Bleed to edges */
            border-bottom: 2px solid var(--term-green);
        }

        /* --- LEFT: PARTS BIN --- */
        #parts-bin {
            grid-column: 1;
            grid-row: 1;
            overflow-y: auto;
        }

            /* 新增：零件箱拖拽悬停高亮 */
            #parts-bin.drag-active {
                border: 2px dashed var(--term-amber) !important;
                background-color: rgba(255, 184, 51, 0.05) !important;
                box-shadow: inset 0 0 20px rgba(255, 184, 51, 0.2) !important;
            }        
            
            .part-card {
            background: #000;
            border: 1px dashed var(--term-green);
            padding: 10px;
            margin-bottom: 10px;
            cursor: grab;
            transition: all 0.3s;
            position: relative;
        }

        /* 给装配槽内的零件添加一个放入动画 */
        .slot .part-card {
            animation: dropIn 0.3s ease-out;
        }

        @keyframes dropIn {
            0% {
                transform: scale(0.8);
                opacity: 0.5;
            }

            60% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

            .part-card:hover {
                border-style: solid;
                box-shadow: 0 0 12px var(--term-green);
                background: #0f1f0f;
                transform: translateY(-3px);
            }

            .part-card:active {
                cursor: grabbing;
                transform: translateY(0);
            }

            /* 添加零件被选中时的效果 */
            .part-card.in-slot {
                border: 2px solid var(--term-amber);
                background: rgba(255, 184, 51, 0.1);
                box-shadow: 0 0 15px rgba(255, 184, 51, 0.5);
            }

        /* === 新增：按钮控制栏样式 === */
        .screen-controls {
            position: absolute; /* 绝对定位 */
            top: 10px; /* 距离顶部10像素 */
            right: 10px; /* 距离右边10像素 */
            z-index: 100; /* 最高层级，确保在最上层 */
            display: flex; /* 水平排列按钮 */
            gap: 8px; /* 按钮间距 */
        }

        .control-btn {
            background-color: rgba(0, 30, 0, 0.8); /* 半透明深绿背景 */
            color: var(--term-green);
            border: 1px solid var(--term-green);
            font-family: var(--font-main);
            font-size: 0.8em;
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 3px;
            text-transform: uppercase; /* 大写字母 */
            letter-spacing: 1px;
        }

            .control-btn:hover {
                background-color: var(--term-green);
                color: #000;
                box-shadow: 0 0 10px rgba(51, 255, 51, 0.5);
            }

            .control-btn:active {
                transform: scale(0.95);
            }

        /* === 新增：针对整个页面全屏的优化样式 === */
        :fullscreen {
            background-color: var(--bg-color) !important; /* 确保背景色统一 */
            padding: 20px !important; /* 保持内边距 */
        }

        /* 浏览器前缀兼容 */
        :-webkit-full-screen {
            background-color: var(--bg-color) !important;
            padding: 20px !important;
        }

        :-moz-full-screen {
            background-color: var(--bg-color) !important;
            padding: 20px !important;
        }        
        
        .card-title { font-weight: bold; font-size: 0.9em; }
        .card-meta { 
            font-size: 0.75em; 
            display: flex; 
            justify-content: space-between; 
            margin-top: 5px; 
            color: var(--term-amber);
        }

        /* --- CENTER: PREVIEW --- */
        #preview-panel {
            grid-column: 2;
            grid-row: 1;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .preview-screen {
            width: 100%; /* 改为100%填满容器 */
            height: 70vh; /* 使用视窗高度单位，更灵活 */
            max-height: 500px; /* 最大高度限制 */
            min-height: 300px; /* 最小高度保证 */
            border: 3px solid var(--term-green);
            margin-bottom: 20px;
            position: relative;
            background-color: #000;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            box-shadow: 0 0 20px rgba(51, 255, 51, 0.4);
            overflow: hidden;
        }

        .mod-icon {
            display: flex; /* 使用弹性布局 */
            align-items: center; /* 垂直居中 */
            justify-content: center; /* 水平居中 */
            width: 100%; /* 宽度100%填满父容器 */
            height: 100%; /* 高度100%填满父容器 */
            overflow: hidden; /* 防止图片溢出 */
        }

        .preview-image {
            width: 100%; /* 宽度100%填满容器 */
            height: 100%; /* 高度100%填满容器 */
            object-fit: contain; /* 保持比例并完整显示，可能会有裁剪 */
            /* object-fit: contain; */ /* 如果想完整显示图片（不裁剪），用这个 */
            border: 2px solid var(--term-dim);
            image-rendering: crisp-edges; /* 更清晰的像素边缘 */
            box-shadow: 0 0 20px rgba(51, 255, 51, 0.4); /* 更强的发光效果 */
            display: block; /* 确保图片是块级元素 */
        }
        
        .preview-content {
            position: absolute; /* 绝对定位，脱离文档流 */
            top: 10px; /* 距离顶部10像素 */
            left: 10px; /* 距离左边10像素 */
            right: 10px; /* 距离右边10像素 */
            z-index: 10; /* 确保文字在图片上方 */
            background-color: rgba(0, 0, 0, 0.7); /* 半透明黑色背景 */
            padding: 15px;
            border: 1px solid var(--term-green);
            border-radius: 5px;
        }

        .mod-title {
            color: var(--term-green);
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 0 8px rgba(51, 255, 51, 0.8);
        }

        .mod-desc {
            color: var(--term-amber);
            font-size: 0.9em;
            line-height: 1.4;
        }

        #publish-btn {
            background: var(--term-green);
            color: #000;
            border: none;
            padding: 15px;
            font-family: var(--font-main);
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
            width: 100%;
            text-transform: uppercase;
            margin-bottom: 20px;
            transition: 0.2s;
        }

        #publish-btn:hover {
            background: var(--term-amber);
            box-shadow: 0 0 15px var(--term-amber);
        }

        #publish-btn:active { transform: scale(0.98); }

        #comments-log {
            flex-grow: 1;
            border-top: 1px dotted var(--term-dim);
            padding-top: 10px;
            overflow-y: auto;
            font-size: 0.8em;
        }

        .comment-entry {
            margin-bottom: 10px;
            border-left: 2px solid var(--term-dim);
            padding-left: 8px;
        }
        .user-name { color: var(--term-amber); font-weight: bold; }

        /* --- BOTTOM: ASSEMBLY --- */
        #assembly-panel {
            grid-column: 1 / span 3;
            grid-row: 2;
            display: flex;
            flex-direction: column;
        }

        .resource-counter {
            text-align: right;
            font-size: 1.2em;
            margin-bottom: 10px;
            color: var(--term-amber);
        }

        .assembly-slots-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            height: 100%;
        }

        .slot {
            width: 150px;
            height: 110px;
            border: 2px dashed var(--term-dim);
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .slot::after {
            content: "EMPTY SLOT";
            position: absolute;
            color: var(--term-dim);
            font-size: 0.8em;
            z-index: 0;
        }

        .slot .part-card {
            width: 130px;
            height: 80px;
            margin: 0;
            z-index: 1;
            background: #000;
        }

        /* Drag Over Highlight */
        .slot.drag-over {
            border-color: var(--term-green);
            background: rgba(51, 255, 51, 0.1);
        }

        .flash-error {
            animation: flashRed 0.5s ease-in-out;
        }

        @keyframes flashRed {
            0%, 100% { color: var(--term-amber); }
            50% { color: var(--term-red); text-shadow: 0 0 10px var(--term-red); }
        }

    </style>
</head>
<body>

    <div class="crt-overlay"></div>

    <div class="workbench-grid">
        
        <!-- LEFT PANEL: PARTS BIN -->
        <div class="panel" id="parts-bin-panel">
            <div class="panel-header">Parts Bin</div>
            <div id="parts-bin" ondrop="drop(event)" ondragover="allowDrop(event)">
                <!-- Generated by JS -->
            </div>
        </div>

        <!-- CENTER PANEL: PREVIEW -->
        <div class="panel" id="preview-panel">
            <div class="panel-header">Simulated Preview</div>
            <div class="preview-screen">
                <!-- 按钮控制栏 - 新添加的部分 -->
                <div class="screen-controls">
                    <button class="control-btn" id="fullscreen-btn" title="全屏显示">
                        ⛶ FULLSCREEN
                    </button>
                    <button class="control-btn" id="exit-fullscreen-btn" title="退出全屏" style="display: none;">
                        ⬌ EXIT
                    </button>
                    <button class="control-btn" id="reset-btn" title="重置所有装配">
                        ↺ REDO
                    </button>
                </div>

                <!-- 图片容器 - 放在最底层 -->
                <div class="mod-icon" id="preview-icon">
                    <!-- 图片会通过JS动态插入到这里 -->
                </div>

                <!-- 文字内容 - 放在上层 -->
                <div class="preview-content">
                    <div class="mod-title" id="preview-title">UNTITLED MOD</div>
                    <div class="mod-desc" id="preview-desc">Add components to the assembly area to compile a preview.</div>
                </div>
            </div>
        </div>

        <!-- RIGHT PANEL: COMMUNITY -->
        <div class="panel" id="community-hub">
            <div class="panel-header">Nexus Uplink</div>
            <button id="publish-btn" onclick="publishMod()">Publish to Nexus</button>
            <div id="comments-log">
                <div style="color: #666;">// WAITING FOR UPLOAD...</div>
            </div>
        </div>

        <!-- BOTTOM PANEL: ASSEMBLY -->
        <div class="panel" id="assembly-panel">
            <div class="panel-header">Assembly Line</div>
            <div class="resource-counter" id="resource-display">RESOURCE POINTS: 5/5</div>
            <div class="assembly-slots-container">
                <div class="slot" ondrop="drop(event)" ondragover="allowDrop(event)" id="slot-1"></div>
                <div class="slot" ondrop="drop(event)" ondragover="allowDrop(event)" id="slot-2"></div>
                <div class="slot" ondrop="drop(event)" ondragover="allowDrop(event)" id="slot-3"></div>
            </div>
        </div>
    </div>

    <script>
        // PIP-Boy风格音效
const audioFiles = {
    click: 'https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3',
    drag: 'https://assets.mixkit.co/sfx/preview/mixkit-plastic-bubble-click-1124.mp3',
    success: 'https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3',
    error: 'https://assets.mixkit.co/sfx/preview/mixkit-warning-alarm-buzzer-1551.mp3',
    uiBeep: 'https://assets.mixkit.co/sfx/preview/mixkit-retro-game-emergency-alarm-1000.mp3'
};

// 创建音频对象
const clickSound = new Audio(audioFiles.click);
const dragSound = new Audio(audioFiles.drag);
const successSound = new Audio(audioFiles.success);
const errorSound = new Audio(audioFiles.error);
const uiBeepSound = new Audio(audioFiles.uiBeep);

// 设置音量（0-1之间）
clickSound.volume = 0.4;
dragSound.volume = 0.3;
successSound.volume = 0.5;
errorSound.volume = 0.4;
uiBeepSound.volume = 0.3;

// 播放音效的辅助函数
function playClickSound() {
    clickSound.currentTime = 0; // 重置播放位置
    clickSound.play().catch(e => console.log("音效播放失败（用户可能还未交互）"));
}

function playDragSound() {
    dragSound.currentTime = 0;
    dragSound.play().catch(e => console.log("音效播放失败"));
}

function playSuccessSound() {
    successSound.currentTime = 0;
    successSound.play().catch(e => console.log("音效播放失败"));
}

function playErrorSound() {
    errorSound.currentTime = 0;
    errorSound.play().catch(e => console.log("音效播放失败"));
}

function playUIBeep() {
    uiBeepSound.currentTime = 0;
    uiBeepSound.play().catch(e => console.log("音效播放失败"));
}

        /* --- GAME DATA --- */
        const partsData = [
            { id: 'p1', name: '4K Texture Pack', cost: 2, tag: 'Visual', desc: "Makes puddles look radioactive." },
            { id: 'p2', name: 'Smart AI Core', cost: 2, tag: 'Gameplay', desc: "Raiders now use actual tactics." },
            { id: 'p3', name: 'Cinematic Soundtrack', cost: 1, tag: 'Audio', desc: "Walking through ruins feels epic." },
            { id: 'p4', name: 'God Rays Shader', cost: 1, tag: 'Visual', desc: "Blinding sun rays through ruins." },
            { id: 'p5', name: 'Hardcore Survival', cost: 3, tag: 'Gameplay', desc: "Radiation actually matters now." },
            { id: 'p6', name: 'Radio New Vegas', cost: 1, tag: 'Audio', desc: "Adds 50+ retro songs to Pip-Boy." }
        ];

        // 扩展的评论库：更多样化、更有趣
        const commentsData = [
            { user: "VaultDweller_101", text: "This mod single-handedly saved my playthrough. Endorsed!" },
            { user: "LorePurist42", text: "Nice work, but the green tint isn't canon for this area." },
            { user: "ModJunkie", text: "Any chance for a F4SE version? Scripts feel lightweight." },
            { user: "ToasterPCGamer", text: "Went from 60 to 15 FPS. Worth it for those textures!" },
            { user: "Nexus_Helper_Bot", text: "Remember to clean your save before installing!" },
            { user: "SettlerJoe", text: "Works with Sim Settlements 2? Can't get it to load..." },
            { user: "Pip-BoyCollector", text: "The UI changes are *chef's kiss*. Finally readable!" },
            { user: "BrotherhoodScribe", text: "Ad Victoriam! This mod serves the Brotherhood well." },
            { user: "MinutemenGeneral", text: "Another settlement needs your help... and this mod!" },
            { user: "RailroadAgent", text: "Hidden feature found: a synth reference in the code. Clever!" },
            { user: "InstituteScientist", text: "The technical implementation is... advanced. Impressive." },
            { user: "MoleratLover99", text: "Can you add a giant molerat boss? Asking for a friend." },
            { user: "WastelandChef", text: "Now if only someone modded in cooking those radroaches..." },
            { user: "PowerArmorFan", text: "T-60 feels clunkier with this. Intentional or bug?" },
            { user: "DogmeatSimp", text: "DOGMEAT RETEXTURE WHEN?! He needs a bandana." },
            { user: "NewVegasRefugee", text: "Brings back memories of the Mojave. Well done." },
            { user: "DialogueSkipUser", text: "Great, but now Preston won't shut up about it." },
            { user: "ModAuthor_Tired", text: "As a fellow creator, I respect the clean scripting." },
            { user: "FirstTimeModder", text: "How do I install this? The README is 10 pages long!" },
            { user: "AchievementHunter", text: "Does this disable achievements? On a fresh run." },
            { user: "VRGuy", text: "Tried in Fallout 4 VR. My headset exploded (not really)." },
            { user: "LeviathanAxe", text: "DOWNLOADING NOW. MY BODY IS READY." }
        ];

// 《辐射》主题图片智能匹配规则 - 升级为支持随机图片池
const imageRules = [
    // 规则1：三个标签 -> 终极改造 (现在有3张图可以随机)
    { 
        tags: ['Visual', 'Gameplay', 'Audio'], 
        images: [
            'https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExNDZvMTRkNXV5NDVoNWdnd3gyM2VxcngwMmhmZHJ6aHNxbWM0bDEzdiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/mBv1pDl2EvnviBAj5S/giphy.gif',
            'https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExazJuZzR6cWxqbW4yOGdxNTRwb283ZjU5NmpjNmxtdmFoa3Z6eHhyNyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/pHYfmV1OLvOjdGYwzj/giphy.gif',
            'https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExMHNjZTZpZmI0Z2xwdWhhYjhhdGhxYzlhajVieDZzY2p5dGdpZWZxYiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/5BWVkL3XncabaZFSJG/giphy.gif',
            'https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExcmF5YXc0b2JrZmNhNGh4dmtlNWRmam12amJwYzJ5ODBtdmY4ZDJweSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/DAFTzKpcBNRVgADMyX/giphy.gif'
        ] 
    },
    
    // 规则2：两个特定标签的组合 -> 混合类型
    { 
        tags: ['Visual', 'Gameplay'], 
        images: [
            'https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExOTdtY3g4NnNvaXl3eGJjOWprN294azUwZGw3aXpybTl0dWV4ZGRudCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/UrsNCpba5y3NBf54G9/giphy.gif',
            'https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExZXh5NHE4eTUwd2U3cDVyMnY5bnQ3d2R4cjBzcmhzMWpmcWJkeGpxcCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/6CBh45sInkBxYyKD9I/giphy.gif',
            'https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExaWVlOW9zbzRzem91bndqb3ZpbWJ1MHA4ZTl4dXVrZ2I1dmNnN2U2cSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/s2Hu61Z9CujrPoIVun/giphy.gif'
        ] 
    },
    { 
        tags: ['Visual', 'Audio'], 
        image: 'https://staticdelivery.nexusmods.com/mods/1151/images/9048-0-1481700060.gif' 
        // 注意：这条规则仍然使用旧的单张图片格式，说明新旧格式可以并存
    },
    { 
        tags: ['Gameplay', 'Audio'], 
        image: 'https://staticdelivery.nexusmods.com/mods/1151/images/9048-3-1478385814.gif' 
    },
    
    // 规则3：单个标签 -> 基础类型
    { 
        tags: ['Visual'], 
        images: [
            'https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExczdlMXZ4ZnpqeHZnM21yZWV0b2VraWU2ZTR0cjdqejRnamZodTc1YiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/35NEOu8KD38MPeggGA/giphy.gif',
            'https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExajVtNWhhNjg3NTVna2E0ZWoxczJwYnVibGVxYmhmZHMwbGU3b3FmbCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/aK2qbB8QuBnZewOWyP/giphy.gif'
        ]
    },
    { tags: ['Gameplay'], image: 'https://staticdelivery.nexusmods.com/mods/1151/images/27479-0-1508690249.gif' },
    { tags: ['Audio'], image: 'https://staticdelivery.nexusmods.com/mods/1151/images/9048-3-1458633384.gif' }
];
        // 默认图片
        const defaultImage = 'https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExejh1M2Z2ZDR2MTBsMWZpcWt6bG90aWNsbmkwNHJkZHR0ang5b2EzOSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/CWcebXJhflE64/giphy.gif';
// 智能图片匹配函数 - 升级为支持随机选择
function findImageForTags(tagArray) {
    const sortedTags = [...tagArray].sort();
    
    // 1. 尝试匹配精确组合
    for (let rule of imageRules) {
        if (JSON.stringify(sortedTags) === JSON.stringify([...rule.tags].sort())) {
            // *** 修改点：优先检查是否有图片池（images），有则随机选一张 ***
            if (rule.images && Array.isArray(rule.images) && rule.images.length > 0) {
                const randomIndex = Math.floor(Math.random() * rule.images.length);
                console.log(`匹配组合 ${sortedTags}，从 ${rule.images.length} 张图中随机选择第 ${randomIndex + 1} 张`);
                return rule.images[randomIndex];
            } 
            // *** 如果没有图片池但有单张图（image），则沿用旧逻辑 ***
            else if (rule.image) {
                console.log(`匹配组合 ${sortedTags}，使用单张图片`);
                return rule.image;
            }
        }
    }
    
    // 2. 都没有匹配上，使用默认图片
    console.log(`未匹配任何组合，使用默认图片`);
    return defaultImage;
}

        let currentResources = 5;
        const maxResources = 5;
        let published = false; // 防止重复发布

        /* --- INITIALIZATION --- */
        window.onload = function() {
            const bin = document.getElementById('parts-bin');
            partsData.forEach(part => {
                const card = document.createElement('div');
                card.className = 'part-card';
                card.draggable = true;
                card.id = part.id;
                card.dataset.cost = part.cost;
                card.dataset.tag = part.tag;
                
                card.innerHTML = `
                    <div class="card-title">${part.name}</div>
                    <div class="card-meta">
                        <span>[${part.tag}]</span>
                        <span>COST: ${part.cost}</span>
                    </div>
                `;
                
                card.addEventListener('dragstart', drag);
                bin.appendChild(card);
            });
            updateUI();
        };

        /* --- DRAG AND DROP LOGIC --- */
function allowDrop(ev) {
    ev.preventDefault();
    const targetId = ev.target.id || ev.target.parentNode.id;
    // 当拖拽到零件箱或装配槽时，添加高亮类
    if(targetId === 'parts-bin') {
        document.getElementById('parts-bin').classList.add('drag-active');
    }
    if(ev.target.classList.contains('slot')) {
        ev.target.classList.add('drag-over');
    }
}

        document.addEventListener('dragleave', (ev) => {
            if(ev.target.classList.contains('slot')) {
                ev.target.classList.remove('drag-over');
            }
        });

function drag(ev) {
    ev.dataTransfer.setData("text", ev.target.id);
    ev.dataTransfer.setData("origin", ev.target.parentNode.id);
    // 开始拖拽时就让零件箱高亮，提示可以放回
    document.getElementById('parts-bin').classList.add('drag-active');
}

function drop(ev) {
    ev.preventDefault();
    const data = ev.dataTransfer.getData("text");
    const originId = ev.dataTransfer.getData("origin");
    const element = document.getElementById(data);
    const cost = parseInt(element.dataset.cost);
    
    let target = ev.target;
    while (!target.classList.contains('slot') && target.id !== 'parts-bin' && target.tagName !== 'BODY') {
        target = target.parentNode;
    }

    // 无论拖拽到哪，结束后都移除所有高亮
    document.getElementById('parts-bin').classList.remove('drag-active');
    document.querySelectorAll('.slot').forEach(s => s.classList.remove('drag-over'));

    if (target.classList.contains('slot')) {
        if (target.children.length > 0) return;
        
        if (originId === 'parts-bin') {
            if (currentResources - cost < 0) {
                flashError();
                return;
            }
        }
        target.appendChild(element);
    } else if (target.id === 'parts-bin') {
        // 如果目标就是零件箱，直接放回去
        target.appendChild(element);
    }

    recalculateState();
}

        // 当拖拽离开时，移除高亮
document.addEventListener('dragleave', function(ev) {
    if(ev.target.id === 'parts-bin') {
        ev.target.classList.remove('drag-active');
    }
    if(ev.target.classList.contains('slot')) {
        ev.target.classList.remove('drag-over');
    }
});

        /* --- STATE MANAGEMENT --- */
        function recalculateState() {
            const slots = document.querySelectorAll('.slot');
            let usedResources = 0;
            let activeTags = [];
            let activeParts = [];

            slots.forEach(slot => {
                if(slot.children.length > 0) {
                    const card = slot.children[0];
                    usedResources += parseInt(card.dataset.cost);
                    activeTags.push(card.dataset.tag);
                    activeParts.push(partsData.find(p => p.id === card.id));
                }
            });

            currentResources = maxResources - usedResources;
            updateUI(activeParts, activeTags);
        }

        function updateUI(parts = [], tags = []) {
            // 更新资源显示
            const counter = document.getElementById('resource-display');
            counter.innerText = `RESOURCE POINTS: ${currentResources}/${maxResources}`;
            counter.style.color = currentResources === 0 ? 'var(--term-red)' : 'var(--term-amber)';

            // 更新预览
            const pTitle = document.getElementById('preview-title');
            const pDesc = document.getElementById('preview-desc');
            const pIcon = document.getElementById('preview-icon');

if (parts.length === 0) {
    pTitle.innerText = "UNTITLED MOD";
    pDesc.innerText = "Add components to the assembly area to compile a preview.";
    // 设置默认图片或清空
    pIcon.innerHTML = '<img src="' + defaultImage + '" class="preview-image">';
} else {
    // 生成标题
    let prefix = "Vanilla";
    if(tags.includes("Visual")) prefix = "Beautiful";
    if(tags.includes("Gameplay")) prefix = "Immersive";
    if(tags.includes("Audio")) prefix = "Cinematic";
    if(tags.includes("Gameplay") && tags.includes("Visual")) prefix = "Overhaul";
    if(tags.includes("Gameplay") && tags.includes("Audio")) prefix = "Intense";
    if(tags.includes("Visual") && tags.includes("Audio")) prefix = "Atmospheric";
    if(tags.includes("Visual") && tags.includes("Gameplay") && tags.includes("Audio")) prefix = "Definitive";
    
    pTitle.innerText = `${prefix} Wasteland`;
    
    // 生成描述
    pDesc.innerText = parts.map(p => p.desc).join(" + ");

    // 图片逻辑：智能匹配图片
    let imageUrl = findImageForTags(tags);
    
    // 使用新的CSS类，图片会填满整个容器
    pIcon.innerHTML = '<img src="' + imageUrl + '" class="preview-image">';
}
        }

function flashError() {
    const counter = document.getElementById('resource-display');
    const assemblyPanel = document.getElementById('assembly-panel');
    counter.classList.add('flash-error');
    assemblyPanel.style.boxShadow = '0 0 15px var(--term-red)';
    setTimeout(() => {
        counter.classList.remove('flash-error');
        assemblyPanel.style.boxShadow = ''; // 移除红光
    }, 800); // 比原来长一点
}

/* --- 增强的发布逻辑 --- */
function publishMod() {
    const publishButton = document.getElementById('publish-btn');
    const log = document.getElementById('comments-log');
    
    // 【步骤一】更清晰的发布前状态检查
    if (published) {
        log.innerHTML = `<div style="color:var(--term-red); border-left:3px solid var(--term-red); padding-left:10px;">
            > <strong>ERROR:</strong> Mod publication status is LOCKED.<br>
            > This configuration has already been published to Nexus.<br>
            > ↻ Please reset the assembly to create a new mod.
        </div>`;
        return; // 直接退出函数，不执行后续代码
    }
    
    const slots = document.querySelectorAll('.slot .part-card');
    if (slots.length === 0) {
        // 使用更醒目的错误提示
        log.innerHTML = `<div style="color:var(--term-red); border-left:3px solid var(--term-red); padding-left:10px;">
            > <strong>ASSEMBLY ERROR:</strong> No components in assembly line.<br>
            > ↻ Please drag at least one part from the bin to proceed.
        </div>`;
        // 添加一个简单的闪烁动画提醒装配区
        document.getElementById('assembly-panel').style.animation = 'flashRed 1s ease 2';
        setTimeout(() => { document.getElementById('assembly-panel').style.animation = ''; }, 2000);
        return;
    }
    
    // 【步骤二】改进按钮状态，明确指示“正在处理”
    publishButton.innerText = "UPLOADING...";
    publishButton.style.background = "var(--term-amber)";
    publishButton.style.cursor = "wait"; // 鼠标变成等待状态
    
    // 【步骤三】优化发布过程日志，模拟更真实的步骤
    log.innerHTML = `
        <div style="color:var(--term-green);">
        > [${new Date().toLocaleTimeString([], {hour12: false})}] INITIATE PUBLISH SEQUENCE<br>
        > Validating assembly configuration... <span style="color:var(--term-amber)">DONE</span><br>
        > Calculating resource allocation... <span style="color:var(--term-amber)">DONE</span><br>
        <span style="color:#666;">> ---</span><br>
        > Compressing mod files (this may take a moment)...<br>
        </div>
    `;
    
    // 模拟一个短暂的“压缩”延迟
    setTimeout(() => {
        log.innerHTML += `<div style="color:var(--term-green);">
            > Compression: <span style="color:var(--term-amber)">██████████ 100%</span><br>
            > Establishing Nexus Uplink... <span style="color:var(--term-amber)">CONNECTED</span><br>
            > Uploading data stream...<br>
        </div>`;
        log.scrollTop = log.scrollHeight;
    }, 800);
    
    // 模拟“上传”延迟并最终完成
    setTimeout(() => {
        log.innerHTML += `<div style="color:var(--term-green);">
            > Upload: <span style="color:var(--term-amber)">██████████ 100%</span><br>
            > Transmitting metadata... <span style="color:var(--term-amber)">DONE</span><br>
            <span style="color:#666;">> ---</span><br>
            > <strong style="color:var(--term-green); text-shadow:0 0 5px var(--term-green);">PUBLICATION SUCCESSFUL</strong><br>
            > Your mod is now live on Nexus.<br>
            > Initial stats: <span style="color:var(--term-amber)">Downloads: 0 | Endorsements: 0 | Views: 1</span><br>
            <span style="color:#666;">> ---</span><br>
            > <em>Community feedback incoming:</em><br><br>
            </div>`;
        log.scrollTop = log.scrollHeight;
        
        // 【步骤四】最终更新按钮为“已发布”状态
        published = true;
        publishButton.innerText = "✓ PUBLISHED";
        publishButton.style.background = "var(--term-dim)";
        publishButton.style.color = "#666";
        publishButton.style.cursor = "not-allowed";
        publishButton.disabled = true; // 直接禁用按钮
        publishButton.onclick = null;
        
        // 【步骤五】调用生成社区评论的函数
        generateCommunityFeedback();
        
    }, 1600);
}

/* --- 新增：独立的社区评论生成函数 --- */
function generateCommunityFeedback() {
    const log = document.getElementById('comments-log');
    const commentCount = 4 + Math.floor(Math.random() * 3);
    const usedIndices = new Set();
    
    for (let i = 0; i < commentCount; i++) {
        let randomIndex;
        do {
            randomIndex = Math.floor(Math.random() * commentsData.length);
        } while (usedIndices.has(randomIndex) && usedIndices.size < commentsData.length);
        usedIndices.add(randomIndex);
        const comment = commentsData[randomIndex];
        
        const hoursAgo = Math.floor(Math.random() * 24);
        const minutesAgo = Math.floor(Math.random() * 60);
        
        // 为每条评论添加一点延迟，使其依次出现
        setTimeout(() => {
            const entry = document.createElement('div');
            entry.className = 'comment-entry';
            entry.innerHTML = `
                <span class="user-name">${comment.user}</span>
                <span style="color:#666; font-size:0.7em;">(${hoursAgo}h ${minutesAgo}m ago)</span><br>
                ${comment.text}
            `;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight; // 自动滚动到最新消息
        }, i * 1000 + 500); // 每条评论间隔1秒出现
    }
    
    // 最后添加系统消息
    setTimeout(() => {
        const systemMsg = document.createElement('div');
        systemMsg.style.marginTop = '15px';
        systemMsg.innerHTML = `<div style="color:#666; font-size:0.8em; border-top:1px dotted var(--term-dim); padding-top:10px;">
            > MOD STATUS: <span style="color:var(--term-green)">ACTIVE</span> | LAST UPDATED: NOW<br>
            > Remember to endorse content you enjoy! Endorsements help mod authors.
        </div>`;
        log.appendChild(systemMsg);
        log.scrollTop = log.scrollHeight;
    }, commentCount * 1000 + 1000);
}

        /* === 新增：全屏和重置功能 - 让按钮真正工作 === */

// 1. 获取按钮和预览屏元素
const fullscreenBtn = document.getElementById('fullscreen-btn');
const exitFullscreenBtn = document.getElementById('exit-fullscreen-btn');
const resetBtn = document.getElementById('reset-btn');
const previewScreen = document.querySelector('.preview-screen');

// 2. 全屏功能
fullscreenBtn.addEventListener('click', function() {
    playUIBeep(); // 添加音效
    // 修改为对整个网页（document.documentElement）进行全屏
    if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen();
    } else if (document.documentElement.webkitRequestFullscreen) {
        document.documentElement.webkitRequestFullscreen();
    } else if (document.documentElement.mozRequestFullScreen) {
        document.documentElement.mozRequestFullScreen();
    }
    // 切换按钮显示
    fullscreenBtn.style.display = 'none';
    exitFullscreenBtn.style.display = 'block';
});

// 3. 退出全屏功能
exitFullscreenBtn.addEventListener('click', function() {
    playUIBeep(); // 添加音效
    // 这里保持不变，因为退出全屏的API是直接调用 document 的
    if (document.exitFullscreen) {
        document.exitFullscreen();
    } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
    } else if (document.mozCancelFullScreen) {
        document.mozCancelFullScreen();
    }
});

// 4. 监听全屏变化（比如用户按了ESC键）
function handleFullscreenChange() {
    // 检查是否还在全屏模式
    const isFullscreen = document.fullscreenElement || 
                         document.webkitFullscreenElement || 
                         document.mozFullScreenElement;
    
    if (!isFullscreen) {
        // 如果退出了全屏，就切换按钮显示
        fullscreenBtn.style.display = 'block';
        exitFullscreenBtn.style.display = 'none';
    }
}

// 为不同浏览器添加事件监听
document.addEventListener('fullscreenchange', handleFullscreenChange);
document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
document.addEventListener('mozfullscreenchange', handleFullscreenChange);

// 5. 重置功能 (REDO按钮) - 直接执行，无需确认
resetBtn.addEventListener('click', resetAssembly);

// 新增：在日志区显示终端风格的确认提示
function showTerminalConfirmation() {
    const log = document.getElementById('comments-log');
    
    // 清除可能存在的旧确认信息
    const oldConfirm = document.getElementById('terminal-confirm');
    if (oldConfirm) oldConfirm.remove();
    
    // 创建并插入一个终端风格的确认消息块
    const confirmMsg = document.createElement('div');
    confirmMsg.id = 'terminal-confirm';
    confirmMsg.style.cssText = `
        color: var(--term-amber);
        border-left: 3px solid var(--term-amber);
        padding: 10px;
        margin: 10px 0;
        background: rgba(255, 184, 51, 0.05);
        font-family: var(--font-main);
    `;
    confirmMsg.innerHTML = `
        > <strong>CONFIRM RESET</strong><br>
        > Are you sure you want to reset the assembly?<br>
        > All parts will be returned to the bin.<br>
        > <span style="color:var(--term-green)">[Y]</span>es / <span style="color:var(--term-red)">[N]</span>o
    `;
    
    // 插入到日志区顶部
    log.insertBefore(confirmMsg, log.firstChild);
    log.scrollTop = 0; // 滚动到顶部看确认信息
    
    // 设置一个一次性键盘事件监听器来处理 Y/N 按键
    function handleKeyPress(e) {
        // 只处理 Y 或 N 键（不区分大小写）
        if (e.key.toLowerCase() === 'y') {
            // 用户确认，执行重置
            resetAssembly();
            // 移除确认消息和键盘监听
            confirmMsg.remove();
            document.removeEventListener('keydown', handleKeyPress);
            // 可选：在日志中添加一条“已确认”的记录
            const doneMsg = document.createElement('div');
            doneMsg.innerHTML = `<span style="color:#666">> Reset confirmed. Executing...</span>`;
            log.insertBefore(doneMsg, log.firstChild);
        } else if (e.key.toLowerCase() === 'n') {
            // 用户取消
            confirmMsg.remove();
            document.removeEventListener('keydown', handleKeyPress);
            // 可选：在日志中添加一条“已取消”的记录
            const cancelMsg = document.createElement('div');
            cancelMsg.innerHTML = `<span style="color:#666">> Reset operation cancelled.</span>`;
            log.insertBefore(cancelMsg, log.firstChild);
        }
        // 按其他键不做反应
    }
    
    // 添加键盘事件监听
    document.addEventListener('keydown', handleKeyPress);
    
    // 可选：设置一个超时（比如15秒后），自动清理未处理的确认请求
    setTimeout(() => {
        if (document.getElementById('terminal-confirm')) {
            document.getElementById('terminal-confirm').remove();
            document.removeEventListener('keydown', handleKeyPress);
            const timeoutMsg = document.createElement('div');
            timeoutMsg.innerHTML = `<span style="color:#666">> Reset confirmation timed out.</span>`;
            log.insertBefore(timeoutMsg, log.firstChild);
        }
    }, 15000); // 15秒后超时
}

// 6. 重置装配的具体函数
function resetAssembly() {
    // 6.1 清空所有装配槽，把零件移回零件箱
    const slots = document.querySelectorAll('.slot');
    const partsBin = document.getElementById('parts-bin');
    
    slots.forEach(slot => {
        if (slot.children.length > 0) {
            const partCard = slot.children[0];
            partsBin.appendChild(partCard); // 移回去
        }
    });
    
    // 6.2 重置核心状态
    currentResources = 5; // 资源回满
    published = false;    // 允许重新发布
    
    // 6.3 重置发布按钮状态
    const publishButton = document.getElementById('publish-btn');
    publishButton.innerText = "Publish to Nexus";
    publishButton.style.background = "var(--term-green)";
    publishButton.style.color = "#000";
    publishButton.style.cursor = "pointer";
    publishButton.disabled = false;
    publishButton.onclick = publishMod; // 重新绑定点击事件
    
    // ... 6.4 更新界面
    updateUI();
    
    // 6.5 在右侧日志中添加或替换重置提示
    const log = document.getElementById('comments-log');
    // 移除可能存在的旧“SYSTEM”重置消息
    const oldSystemMessages = log.querySelectorAll('.comment-entry:has(.user-name:contains("SYSTEM"))');
    oldSystemMessages.forEach(msg => {
        // 检查消息内容是否与重置相关，避免误删评论
        if (msg.textContent.includes('assembly line has been reset') || msg.textContent.includes('资源点已恢复')) {
            msg.remove();
        }
    });

    const resetMsg = document.createElement('div');
    resetMsg.className = 'comment-entry';
    resetMsg.innerHTML = `
        <span class="user-name">SYSTEM</span> 
        <span style="color:#666; font-size:0.7em;">(${new Date().toLocaleTimeString([], {hour12: false})})</span><br>
        > Assembly line reset. Resource pool restored to 5/5.
    `;
    // 加到日志顶部，在“等待上传”提示之后
    const waitingMsg = log.querySelector('div[style*="WAITING FOR UPLOAD"]');
    if (waitingMsg) {
        log.insertBefore(resetMsg, waitingMsg.nextSibling);
    } else {
        log.insertBefore(resetMsg, log.firstChild);
    }
}

    </script>
</body>
</html>